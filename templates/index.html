<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì˜¤ëŠ˜ ì˜¤ì¥?</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: sans-serif;
      background: #f0f4f8;
      min-height: 100dvh;
      padding: 16px;
      color: #222;
    }

    h1 { font-size: 1.5rem; text-align: center; margin-bottom: 4px; }
    .subtitle { text-align: center; color: #888; font-size: 0.85rem; margin-bottom: 20px; }

    /* â”€â”€ ë¡œë¹„ â”€â”€ */
    #lobby {
      max-width: 360px;
      margin: 60px auto 0;
      background: white;
      border-radius: 16px;
      padding: 28px 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #lobby h2 { font-size: 1.2rem; text-align: center; }

    #lobby input {
      width: 100%;
      padding: 12px;
      border: 1.5px solid #ddd;
      border-radius: 10px;
      font-size: 1rem;
      outline: none;
      text-align: center;
    }

    .name-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .name-btn {
      padding: 10px 6px;
      font-size: 0.9rem;
      background: #f5f5f5;
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
    }

    .name-btn.selected { border-color: #4a90e2; background: #e8f0fc; font-weight: bold; }

    #name-input-wrap { display: none; }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
    }

    .emoji-btn {
      font-size: 1.6rem;
      padding: 6px;
      background: #f5f5f5;
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      transition: border-color 0.15s;
    }
    .emoji-btn.selected { border-color: #4a90e2; background: #e8f0fc; }

    #join-btn {
      width: 100%;
      padding: 13px;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
    }
    #join-btn:disabled { opacity: 0.4; }

    /* â”€â”€ ë©”ì¸ â”€â”€ */
    #main { display: none; max-width: 480px; margin: 0 auto; }

    .section {
      background: white;
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 14px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
    }

    .section-title {
      font-size: 0.75rem;
      color: #888;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* ì˜¤ì¥ í† ê¸€ */
    #toggle-btn {
      width: 100%;
      padding: 18px;
      font-size: 1.3rem;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #toggle-btn.going    { background: #d4edda; color: #155724; }
    #toggle-btn.notgoing { background: #f8d7da; color: #721c24; }

    /* ì‹ì‚¬ ì‹œê°„ */
    #time-section { display: none; }

    .time-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .time-btn {
      padding: 11px 6px;
      font-size: 0.9rem;
      background: #f5f5f5;
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
    }
    .time-btn.selected { border-color: #4a90e2; background: #e8f0fc; font-weight: bold; }

    #time-input-wrap {
      display: none;
      margin-top: 10px;
    }

    #time-input {
      width: 100%;
      padding: 11px;
      border: 1.5px solid #ddd;
      border-radius: 10px;
      font-size: 0.95rem;
      outline: none;
      background: #fff;
    }

    /* ì‹ë‹¹ ì„ íƒ */
    #restaurant-section { display: none; }

    .restaurant-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .rest-btn {
      padding: 10px 6px;
      font-size: 0.85rem;
      background: #f5f5f5;
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
    }
    .rest-btn.selected { border-color: #4a90e2; background: #e8f0fc; font-weight: bold; }

    #custom-place-input {
      width: 100%;
      padding: 11px;
      border: 1.5px solid #ddd;
      border-radius: 10px;
      font-size: 0.9rem;
      outline: none;
      margin-top: 10px;
    }

    /* ë©”ë‰´ ì…ë ¥ */
    #menu-section { display: none; }

    #menu-input {
      width: 100%;
      padding: 11px;
      border: 1.5px solid #ddd;
      border-radius: 10px;
      font-size: 0.95rem;
      outline: none;
    }

    /* ì°¸ê°€ì ëª©ë¡ */
    #player-list { list-style: none; display: flex; flex-direction: column; gap: 10px; }

    .player-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 10px;
    }

    .player-emoji { font-size: 2rem; }

    .player-info { flex: 1; }
    .player-name { font-weight: bold; font-size: 0.95rem; }
    .player-detail { font-size: 0.8rem; color: #666; margin-top: 2px; }

    .badge {
      font-size: 0.75rem;
      padding: 3px 9px;
      border-radius: 20px;
      font-weight: bold;
    }
    .badge.going    { background: #d4edda; color: #155724; }
    .badge.notgoing { background: #f8d7da; color: #721c24; }

    #empty-msg { text-align: center; color: #aaa; font-size: 0.9rem; padding: 20px 0; }
  </style>
</head>
<body>

<!-- ë¡œë¹„ -->
<div id="lobby">
  <h2>ğŸ± ì˜¤ëŠ˜ ì˜¤ì¥?</h2>
  <div>
    <div class="section-title" style="margin-bottom:8px">ì´ë¦„ ì„ íƒ</div>
    <div class="name-grid" id="name-grid">
      <!-- JSë¡œ ìƒì„± -->
    </div>
  </div>
  <div id="name-input-wrap">
    <input id="name-input" type="text" placeholder="ê·¸ ì™¸ ì¸ë¬¼ ì´ë¦„ ì…ë ¥" maxlength="12" />
  </div>
  <div>
    <div class="section-title" style="margin-bottom:8px">ìºë¦­í„° ì„ íƒ</div>
    <div class="emoji-grid" id="emoji-grid">
      <!-- JSë¡œ ìƒì„± -->
    </div>
  </div>
  <button id="join-btn" disabled onclick="joinApp()">ì…ì¥í•˜ê¸°</button>
</div>

<!-- ë©”ì¸ -->
<div id="main">
  <h1>ğŸ± ì˜¤ëŠ˜ ì˜¤ì¥?</h1>
  <p class="subtitle">ì‹¤ì‹œê°„ ì ì‹¬ í˜„í™©</p>

  <!-- ì˜¤ì¥ í† ê¸€ -->
  <div class="section">
    <div class="section-title">ë‚˜ì˜ ìƒíƒœ</div>
    <button id="toggle-btn" class="notgoing" onclick="toggleGoing()">
      âŒ ì•ˆ ê°€
    </button>
  </div>

  <!-- ì‹ì‚¬ ì‹œê°„ -->
  <div class="section" id="time-section">
    <div class="section-title">ì–¸ì œ ë¨¹ì„ê¹Œ?</div>
    <div class="time-grid" id="time-grid">
      <!-- JSë¡œ ìƒì„± -->
    </div>
    <div id="time-input-wrap">
      <input id="time-input" type="time" value="11:40" />
    </div>
  </div>

  <!-- ì‹ë‹¹ ì„ íƒ -->
  <div class="section" id="restaurant-section">
    <div class="section-title">ì–´ë””ë¡œ?</div>
    <div class="restaurant-grid" id="restaurant-grid">
      <!-- JSë¡œ ìƒì„± -->
    </div>
    <input id="custom-place-input" type="text" placeholder="ë‹¤ë¥¸ ì¥ì†Œë¼ë©´ ì§ì ‘ ì…ë ¥ (ex. ì™¸ë¶€ ì‹ë‹¹)" maxlength="30" />
  </div>

  <!-- ë©”ë‰´ ì…ë ¥ -->
  <div class="section" id="menu-section">
    <div class="section-title">ì˜¤ëŠ˜ ë©”ë‰´</div>
    <input id="menu-input" type="text" placeholder="ex) ê¹€ì¹˜ì°Œê°œ, íŒŒìŠ¤íƒ€..." maxlength="30" />
  </div>

  <!-- ì°¸ê°€ì ëª©ë¡ -->
  <div class="section">
    <div class="section-title">ì°¸ê°€ì í˜„í™©</div>
    <ul id="player-list"></ul>
    <div id="empty-msg">ì•„ì§ ì•„ë¬´ë„ ì—†ì–´ìš”</div>
  </div>
</div>

<script>
  const socket = io();
  const PRESET_NAMES = ["ì€ì†¡", "ì˜ì€", "ë¬´ì—°"];
  const CUSTOM_NAME_VALUE = "__custom__";
  const EMOJIS = ["ğŸ±","ğŸ¶","ğŸ¹","ğŸ»","ğŸ¦Š","ğŸ¸","ğŸ¼","ğŸ¦","ğŸ¯","ğŸ§"];
  const DEFAULT_MEET_TIME = "11:50"; // í‰ì†Œ(ì˜¤ì¥) ì‹œê°„
  const MEAL_TIMES = [
    { label: "í‰ì†Œ 11:50 (ì˜¤ì¥)", value: "regular" },
    { label: "ì¡°ê¸ˆ ì¼ì° (ì‹œê°„ ì„ íƒ)", value: "early" },
  ];
  const RESTAURANTS = ["íˆ¬ê²Œë”í™€","íŒ¨ë°€ë¦¬í™€","R3","R4","R5"];

  let myName = "";
  let selectedName = "";
  let myEmoji = "";
  let going = false;
  let mealTime = "regular";
  let meetTime = DEFAULT_MEET_TIME;
  let restaurant = "";
  let customPlace = "";
  let composing = false;  // IME ì¡°í•© ìƒíƒœ ì§ì ‘ ì¶”ì 

  // â”€â”€ ì´ë¦„ ë²„íŠ¼ ìƒì„± â”€â”€
  const nameGrid = document.getElementById("name-grid");
  const nameInputWrap = document.getElementById("name-input-wrap");
  const nameInput = document.getElementById("name-input");

  function updateNameUI() {
    nameInputWrap.style.display = selectedName === CUSTOM_NAME_VALUE ? "block" : "none";
  }

  function getChosenName() {
    if (selectedName === CUSTOM_NAME_VALUE) return nameInput.value.trim();
    return selectedName;
  }

  [...PRESET_NAMES, "ì§ì ‘ ì…ë ¥"].forEach(name => {
    const isCustom = name === "ì§ì ‘ ì…ë ¥";
    const value = isCustom ? CUSTOM_NAME_VALUE : name;
    const btn = document.createElement("button");
    btn.className = "name-btn";
    btn.textContent = name;
    btn.onclick = () => {
      document.querySelectorAll(".name-btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      selectedName = value;
      if (!isCustom) {
        nameInput.value = "";
      }
      updateNameUI();
      updateJoinBtn();
    };
    nameGrid.appendChild(btn);
  });

  updateNameUI();

  // â”€â”€ ì´ëª¨ì§€ ë²„íŠ¼ ìƒì„± â”€â”€
  const emojiGrid = document.getElementById("emoji-grid");
  EMOJIS.forEach(em => {
    const btn = document.createElement("button");
    btn.className = "emoji-btn";
    btn.textContent = em;
    btn.onclick = () => {
      document.querySelectorAll(".emoji-btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      myEmoji = em;
      updateJoinBtn();
    };
    emojiGrid.appendChild(btn);
  });


  // â”€â”€ ì‹ì‚¬ ì‹œê°„ ë²„íŠ¼ ìƒì„± â”€â”€
  const timeGrid = document.getElementById("time-grid");
  const timeInputWrap = document.getElementById("time-input-wrap");
  const timeInput = document.getElementById("time-input");

  function syncTimeUI() {
    timeInputWrap.style.display = mealTime === "early" ? "block" : "none";
  }

  MEAL_TIMES.forEach(({ label, value }) => {
    const btn = document.createElement("button");
    btn.className = `time-btn ${value === mealTime ? "selected" : ""}`;
    btn.textContent = label;
    btn.onclick = () => {
      document.querySelectorAll(".time-btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      mealTime = value;
      if (mealTime === "regular") {
        meetTime = DEFAULT_MEET_TIME;
      } else {
        meetTime = timeInput.value || "11:40";
      }
      syncTimeUI();
      sendUpdate();
    };
    timeGrid.appendChild(btn);
  });

  timeInput.addEventListener("input", () => {
    if (mealTime === "early") {
      meetTime = timeInput.value || "11:40";
      sendUpdate();
    }
  });

  // â”€â”€ ì‹ë‹¹ ë²„íŠ¼ ìƒì„± â”€â”€
  syncTimeUI();

  const restGrid = document.getElementById("restaurant-grid");
  RESTAURANTS.forEach(r => {
    const btn = document.createElement("button");
    btn.className = "rest-btn";
    btn.textContent = r;
    btn.onclick = () => {
      document.querySelectorAll(".rest-btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      restaurant = r;
      customPlace = "";
      document.getElementById("custom-place-input").value = "";
      sendUpdate();
    };
    restGrid.appendChild(btn);
  });

  function updateJoinBtn() {
    const name = getChosenName();
    document.getElementById("join-btn").disabled = !(name && myEmoji);
  }

  // â”€â”€ IME ì•ˆì „í•œ Enter ì²˜ë¦¬ â”€â”€
  // isComposing ëŒ€ì‹  compositionstart/end ì§ì ‘ ì¶”ì  (ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ë¬¸ì œ íšŒí”¼)
  nameInput.addEventListener("compositionstart", () => composing = true);
  nameInput.addEventListener("compositionend",   () => composing = false);
  nameInput.addEventListener("input", updateJoinBtn);
  nameInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !composing) joinApp();
  });

  const customPlaceInput = document.getElementById("custom-place-input");
  customPlaceInput.addEventListener("compositionstart", () => composing = true);
  customPlaceInput.addEventListener("compositionend",   () => composing = false);
  customPlaceInput.addEventListener("input", () => {
    customPlace = customPlaceInput.value.trim();
    if (customPlace) {
      restaurant = "";
      document.querySelectorAll(".rest-btn").forEach(b => b.classList.remove("selected"));
    }
    sendUpdate();
  });

  const menuInput = document.getElementById("menu-input");
  menuInput.addEventListener("compositionstart", () => composing = true);
  menuInput.addEventListener("compositionend",   () => composing = false);
  menuInput.addEventListener("input", () => sendUpdate());

  // â”€â”€ ì…ì¥ â”€â”€
  function joinApp() {
    const name = getChosenName();
    if (!name || !myEmoji) return;
    myName = name;

    document.getElementById("lobby").style.display = "none";
    document.getElementById("main").style.display = "block";

    socket.emit("join", { name: myName, emoji: myEmoji });
  }

  // â”€â”€ ì˜¤ì¥ í† ê¸€ â”€â”€
  function toggleGoing() {
    going = !going;
    const btn = document.getElementById("toggle-btn");
    if (going) {
      btn.textContent = "âœ… ì˜¤ì¥!";
      btn.className = "going";
      document.getElementById("time-section").style.display = "block";
      document.getElementById("restaurant-section").style.display = "block";
      document.getElementById("menu-section").style.display = "block";
    } else {
      btn.textContent = "âŒ ì•ˆ ê°€";
      btn.className = "notgoing";
      document.getElementById("time-section").style.display = "none";
      document.getElementById("restaurant-section").style.display = "none";
      document.getElementById("menu-section").style.display = "none";
      mealTime = "regular";
      meetTime = DEFAULT_MEET_TIME;
      timeInput.value = "11:40";
      syncTimeUI();
      restaurant = "";
      customPlace = "";
      document.getElementById("custom-place-input").value = "";
      document.querySelectorAll(".time-btn").forEach((b, idx) => b.classList.toggle("selected", idx === 0));
      document.querySelectorAll(".rest-btn").forEach(b => b.classList.remove("selected"));
    }
    sendUpdate();
  }

  // â”€â”€ ìƒíƒœ ì„œë²„ ì „ì†¡ â”€â”€
  function sendUpdate() {
    socket.emit("update", {
      going,
      meal_time: mealTime,
      meet_time: meetTime,
      restaurant,
      custom_place: customPlace,
      menu: document.getElementById("menu-input").value.trim(),
    });
  }

  // â”€â”€ ì°¸ê°€ì ëª©ë¡ ìˆ˜ì‹  â”€â”€
  socket.on("player_list", ({ players }) => {
    const list = document.getElementById("player-list");
    const empty = document.getElementById("empty-msg");
    list.innerHTML = "";

    if (players.length === 0) {
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    players.forEach(p => {
      const li = document.createElement("li");
      li.className = "player-card";

      const place = p.restaurant || p.custom_place || "";
      const meetTimeLabel = p.meet_time || (p.meal_time === "early" ? "ì‹œê°„ ë¯¸ì •" : DEFAULT_MEET_TIME);
      const mealTimeLabel = p.meal_time === "early"
        ? `ì¡°ê¸ˆ ì¼ì° (${meetTimeLabel})`
        : `í‰ì†Œ 11:50 (ì˜¤ì¥)`;
      const detail = [
        p.going ? mealTimeLabel : null,
        p.going && place ? place : null,
        p.going && p.menu ? p.menu : null,
      ].filter(Boolean).join(" Â· ") || "";

      li.innerHTML = `
        <div class="player-emoji">${p.emoji}</div>
        <div class="player-info">
          <div class="player-name">${p.name}</div>
          ${detail ? `<div class="player-detail">${detail}</div>` : ""}
        </div>
        <div class="badge ${p.going ? "going" : "notgoing"}">
          ${p.going ? "ì˜¤ì¥ âœ…" : "ì•ˆ ê°€ âŒ"}
        </div>
      `;
      list.appendChild(li);
    });
  });
</script>

</body>
</html>
